---
layout: post
tags: 游戏 开发 PICO-8
title: PICO-8 按键控制
---

PICO-8 最多支持两个手柄，每个玩家拥有4个方向键和两个功能键（表示为 O/X），其默认的键盘映射为：

| 玩家 | 左  | 右  | 上  | 下  | O     | X     |
| ---- | --- | --- | --- | --- | ----- | ----- |
| 1P   | ←   | →   | ↑   | ↓   | Z/C/N | X/V/M |
| 2P   | S   | F   | E   | D   | Tab   | Q     |

在控制台中输入 `keyconfig` 命令可自定义按键。

PICO-8 通过SDL2支持手柄控制，配置手柄需要在软件的文件夹下自己添加 `sdl_controllers.txt` 文件。

## 按键检测

编写 PICO-8 按键检测程序主要用到两个函数：

- `btn(x)`：检测按键是否按下，x为要检测的键位。
- `btnp(x)`：检测按键是否**刚刚**抬起（也就是在上一帧为按下，这一帧为抬起）。

以上两个函数均返回布尔值。

一个简单的移动控制示例：

```lua
function _init()
    x = 64
    y = 64
end

function _update()
    -- 检测按键
    if btn(0) then x -= 1 end
    if btn(1) then x += 1 end
    if btn(2) then y -= 1 end
    if btn(3) then y += 1 end
end

function _draw()
    cls()
    circfill(x, y, 4)
end
```

在 PICO-8 中运行这段程序，就可以显示一个由键盘控制移动的圆。

![move circle](/assets/20230412a.gif)

其中 0~5，6~11分别表示1P和2P的按键，其中1P的按键还可以用符号表示。

PICO-8 将小写字母显示为大写，为每个大写字母字符设置为一个对应的图案。这套映射方案称为 P8SCII（捏他自 ASCII）。1P玩家的按键对应的大写字母是：U(p)、D(own)、L(eft)、R(ight)、O、X，这些大写字母可以用来表示对应的按键。

![p8 button](/assets/20230412b.png)

## 所有按键

要对所有按键做出同一响应，不熟悉按键接口的人很容易写成：

```lua
if btn(0)
or btn(1)
or btn(2)
or btn(3)
or btn(4)
or btn(5) then
    do_sth()
end
```

实际上有更简便的写法：

```lua
if btn() > 0 then
    do_sth()
end
```

`btn()` 和 `btnp()` 在不传入参数时，会将当前的按键状态，用数值表示返回，只要是非0数值，就是有按键按下。

各个按键单独按下时返回值为

| 玩家 | 左  | 右  | 上   | 下   | O    | X    |
| ---- | --- | --- | ---- | ---- | ---- | ---- |
| 1P   | 1   | 2   | 4    | 8    | 16   | 32   |
| 2P   | 256 | 512 | 1024 | 2048 | 4096 | 8192 |

所以 `btn()>0` 就可以表示任意按键按下时的情况。

## 组合键

继续观察一下这些数字，可以发现后一个按键是前一个的2倍，而不是+1。说明在内存上这些状态储存的位置是连在一起的，调用时就将按键状态对应的二进制数转化为十进制数返回。

这个特性还可以用来检测组合键。

比如1P玩家同时按下：右+上+冲刺键（O键），那么就要角色就要做一个右上冲的动作，一般写法：

```lua
if btnp(2) and btnp(3) and btnp(4) then
    right_up_dash()
end
```

也可以直接把三个键的值相加：

```lua
if btnp() == 2+4+16 then right_up_dash() end
```

更加简洁直观。