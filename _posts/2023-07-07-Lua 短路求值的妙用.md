---
layout: post
tags: 开发 Lua
title: Lua 短路求值的妙用
---

## 三元操作符

三元操作符（又称三目操作符）是一个简单的条件语句，可以用于简化只对一个值进行判断并决定赋值的 if-else 语句，其形式为：

在 Lua 中没有三元操作符，可以通过以下方式模拟：

```lua
x = a and b or c
```

与之等价的 if-else 语句：

```lua
if a then
    x = b
else
    x = c
end
```

这里用到了 Lua 短路取值的特性，`and` 前值为假时直接返回前值；`or` 前值为假时直接返回后值。这样，a 的真假决定了结果是 b 还是 c，这正是三元操作符的功能。

但是此式有一个缺陷，就是 a 真但 b 假时，b 进入了第二步 or 的计算，or 在前值为假时直接返回后值。此时，在 a 真的情况下，c 却被返回了。

所以，为了排除 b 对判断的干扰，要用列表包裹结果，判断结束后再取出。因为不管列表内的值如何，列表永远等价于真值。

由此得出 Lua 三元操作符的完全形态：

```lua
x = (a and {b} or {c})[1]
```

## 可选参数默认值

前值为 `false`  或者 `nil`  时，`or` 直接返回后值。

此法可用于设置函数可选参数的默认值，或在初始化某变量时，希望沿用该变量可能存在的值。

```lua
local a = a or {}
```

## 安全访问

访问 Lua 的表时，如果无法保证表的内容和范围是否包括了访问字段，就可以通过 or 来进行安全访问。

Lua 表在访问目标不存在时，返回 `nil`，而 `or` 的前值为 `nil` （被视同 `false`）时直接返回后值，也就是你设置的安全值。

```lua
board = {
	{1, 2, 3},
	{4, 5, 6},
	{7, 8, 9}
}

ok = (board[4] or {})[4] or 0
```